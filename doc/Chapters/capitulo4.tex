\chapter{Estrutura}
\label{cap:Estrutura}


A arquitectura foi pensada para ser executada de forma ortogonal ao sistema
utilizado. Desta forma não existe a necessidade de recompilar programas
antigos. Para além desta situação novas aplicações podem utilizar esta
ferramenta de forma transparente.

Esta ferramenta foi desenvolvida para os processadores x86 e x86\_64 pois nestas
arquitecturas existe suporte para o sistema de monitorização KProbes \ref{},
sendo que é a unica dependência especifica que a ferramenta irá ter.

As diferentes partes da ferramenta foram desenvolvidas de forma a poderem ser
utilizadas em separado  
Foi desenvolvida uma arquitectura modular suportada em 4 subpartes.  para
que fosse possível um desenvolvimento 

Filter 
Necessidade de registar um \textit{hook} para aceder directamente à função de
filtro. Caso este \textit{hook} não esteja ligado o \textit{overhead}
introduzido será o de um teste para verificar se existe ligação ou não.
No caso de não existir a ligação a este \textit{hook} o sistema comporta-se de
forma a utilizar apenas o sistema anterior.

\section{Módulos no espaço do núcleo}

A estratégia foi separar os diferentes componentes e a criação de um módulo de
\textit{debug} para que pudesse existir uma forma de acesso à monitorização por
parte do nível de utilizador, sem que exista a necessidade de criar ou alterar
chamadas ao sistema ou suas opções.

\paragraph{Estruturas}

A não criação de novas estruturas de dados, foi devido à existência das
estruturas de dados existentes no código do núcleo do sistema de operação
linux, que já foram bastante analisadas e existem com o propósito de serem
utilizadas por outros programadores.

\paragraph{Divisão do módulo} 

O módulo subdivide-se em 4 partes, a monitorização, o ``reservatório'' de
informação, o \textit{hook} da ligação com o \textit{bpf} e
comunicação/\textit{debug}.

\paragraph{Interacção com o LSF}
O sistema interage também com o \textit{LSF} pois existe uma conjunção
entre o filtro definido pelo utilizador e a captura do tráfego da aplicação a
ser monitorizada.

\section{Desenho da Arquitectura}



\subsection{Monitorização da aplicação}

Como foi apresentado no quadro \ref{tab:monitoring} o sistema de monitorização
do núcleo do sistema linux que se adapta melhor para este problema é o
KProbes\ref{sec:kprobes}. 

\subsection{Repositório de dados}

Para permitir a consulta dos pares número de porta endereço é necessário
utilizar um repositório de dados. Este repositório de dados necessitará de alta
performance mas facilidade de utilização e modificação. Terá de permitir as
seguintes operações: adição, consulta e remoção de dados.

Este repositório de dados irá ser a ponte entre o sistema de  monitorização e o
sistema de filtragem de pacotes. 

\subsection{Filtragem de pacotes}

Sistema que irá indicar à função run\_filter do \textit{LSF} se um pacote deverá
ser capturado ou não. Irá ser definido um ponto \textit{hook} dentro do núcleo
do sistema do linux, de forma a poder ser utilizada a funcionalidade de
filtragem dinâmica apenas quando se deseje. O custo introduzido para estas
modificação é apenas de uma verificação se o \textit{hook} está ligado ou não.


\subsection{Recolha de informações}

Utilizando um dos sistemas definidos em \ref{tab:transferencia_dados} é
permitido o acesso a informações de análise dos diversos sistemas anteriormente
mencionados.
